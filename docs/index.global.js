"use strict";(()=>{var mo=Object.create;var Ae=Object.defineProperty,xo=Object.defineProperties,yo=Object.getOwnPropertyDescriptor,go=Object.getOwnPropertyDescriptors,So=Object.getOwnPropertyNames,xe=Object.getOwnPropertySymbols,vo=Object.getPrototypeOf,Ee=Object.prototype.hasOwnProperty,lt=Object.prototype.propertyIsEnumerable;var it=(e,t,o)=>t in e?Ae(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,W=(e,t)=>{for(var o in t||={})Ee.call(t,o)&&it(e,o,t[o]);if(xe)for(var o of xe(t))lt.call(t,o)&&it(e,o,t[o]);return e},V=(e,t)=>xo(e,go(t));var ye=(e,t)=>{var o={};for(var r in e)Ee.call(e,r)&&t.indexOf(r)<0&&(o[r]=e[r]);if(e!=null&&xe)for(var r of xe(e))t.indexOf(r)<0&&lt.call(e,r)&&(o[r]=e[r]);return o};var I=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var ho=(e,t,o,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of So(t))!Ee.call(e,n)&&n!==o&&Ae(e,n,{get:()=>t[n],enumerable:!(r=yo(t,n))||r.enumerable});return e};var a=(e,t,o)=>(o=e!=null?mo(vo(e)):{},ho(t||!e||!e.__esModule?Ae(o,"default",{value:e,enumerable:!0}):o,e));var d=I((jo,ut)=>{ut.exports=globalThis.React});var Y=I((er,pt)=>{pt.exports=globalThis.RTK});var Oe=I((pr,wt)=>{wt.exports=globalThis.ReactRedux});var Et=I(be=>{"use strict";var bo=d(),ko=Symbol.for("react.element"),Co=Symbol.for("react.fragment"),To=Object.prototype.hasOwnProperty,Po=bo.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,wo={key:!0,ref:!0,__self:!0,__source:!0};function At(e,t,o){var r,n={},i=null,s=null;o!==void 0&&(i=""+o),t.key!==void 0&&(i=""+t.key),t.ref!==void 0&&(s=t.ref);for(r in t)To.call(t,r)&&!wo.hasOwnProperty(r)&&(n[r]=t[r]);if(e&&e.defaultProps)for(r in t=e.defaultProps,t)n[r]===void 0&&(n[r]=t[r]);return{$$typeof:ko,type:e,key:i,ref:s,props:n,_owner:Po.current}}be.Fragment=Co;be.jsx=At;be.jsxs=At});var u=I((xr,Mt)=>{"use strict";Mt.exports=Et()});var Xe=I((_n,Xt)=>{Xt.exports={v4:globalThis.uuidv4}});var ao=I((ms,no)=>{no.exports=globalThis.ReactDOM});var io=I(at=>{"use strict";var so=ao();at.createRoot=so.createRoot,at.hydrateRoot=so.hydrateRoot;var xs});var Qt=a(d());var Le=a(d());var ft=a(Y()),Do={activeLayer:"token",position:{x:0,y:0,z:1}},dt=(0,ft.createSlice)({name:"app",initialState:Do,reducers:{openContextMenu(e,{payload:t}){e.contextMenu=t},closeContextMenu(e){e.contextMenu=void 0},openDialog(e,{payload:t}){e.dialog=t},closeDialog(e){e.dialog=void 0},setActiveLayer(e,{payload:t}){e.activeLayer=t},setDragging(e,{payload:t}){e.dragging=t},setPosition(e,{payload:t}){e.position.x=t.x,e.position.y=t.y,e.position.z=t.z}}}),{closeContextMenu:se,closeDialog:Z,openContextMenu:ct,openDialog:Me,setDragging:X,setActiveLayer:Re,setPosition:mt}=dt.actions,xt=dt.reducer;var ge=a(Y()),G=(0,ge.createEntityAdapter)(),yt=(0,ge.createSlice)({name:"backdrops",initialState:G.getInitialState(),reducers:{addBackdrop:G.upsertOne,addBackdrops:G.upsertMany,updateBackdrop:G.updateOne}}),{addBackdrop:gt,addBackdrops:rr,updateBackdrop:St}=yt.actions,vt=yt.reducer;var Se=a(Y()),K=(0,Se.createEntityAdapter)(),ht=(0,Se.createSlice)({name:"tokens",initialState:K.getInitialState(),reducers:{addToken:K.upsertOne,addTokens:K.upsertMany,updateToken:K.updateOne}}),{addToken:Dt,addTokens:bt,updateToken:kt}=ht.actions,Ct=ht.reducer;var q=e=>e.app.activeLayer,ve=e=>e.app.contextMenu,$=e=>e.app.dialog,he=e=>e.app.dragging,J=e=>e.app.position,{selectAll:Tt,selectEntities:lr}=K.getSelectors(e=>e.tokens),{selectAll:Pt}=G.getSelectors(e=>e.backdrops);var De=a(Oe()),m=De.useDispatch,f=De.useSelector;var ke=a(u()),Eo={position:"absolute",left:0,top:0,bottom:0,right:0,zIndex:99,background:"black",opacity:.1};function Rt({isShown:e,onClick:t}){return e?(0,ke.jsx)("div",{style:Eo,onClick:t}):null}function Ot(){let e=m(),t=f(ve),o=(0,Le.useCallback)(()=>{e(se())},[e]);return(0,ke.jsx)(Rt,{isShown:!!t,onClick:o})}function Lt(){let e=m(),t=f($),o=(0,Le.useCallback)(()=>{e(Z())},[e]);return(0,ke.jsx)(Rt,{isShown:!!t,onClick:o})}var v=a(d());var E=a(d());var ie=a(d());function Be(e=!1){let[t,o]=(0,ie.useState)(e),r=(0,ie.useCallback)(()=>o(!1),[]),n=(0,ie.useCallback)(()=>o(!0),[]);return[t,{clear:r,set:n}]}function Ie(e,t=0){let[o,{clear:r,set:n}]=Be(!1),[i,s]=(0,E.useState)(NaN),[l,x]=(0,E.useState)(NaN),g=(0,E.useMemo)(()=>o?"grabbing":"grab",[o]),S=(0,E.useCallback)(c=>{c.button===t&&(n(),s(c.clientX),x(c.clientY))},[t,n]),y=(0,E.useCallback)(c=>{if(o){let L=c.clientX-i,P=c.clientY-l;e(L,P),s(c.clientX),x(c.clientY)}},[o,e,i,l]),p=(0,E.useCallback)(c=>{o&&(y(c),r())},[o,r,y]);return{cursor:g,onPointerDown:S,onPointerUp:p,onPointerMove:y}}function Bt(e){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];e&&e.addEventListener&&e.addEventListener.apply(e,t)}function It(e){for(var t=[],o=1;o<arguments.length;o++)t[o-1]=arguments[o];e&&e.removeEventListener&&e.removeEventListener.apply(e,t)}var Ce=typeof window<"u";var zt=a(d()),Mo=function(e){(0,zt.useEffect)(e,[])},le=Mo;var Q=a(d());var Ht=a(d());var Ro=function(e){var t=(0,Ht.useRef)(e);t.current=e,le(function(){return function(){return t.current()}})},Ft=Ro;var Oo=function(e){var t=(0,Q.useRef)(0),o=(0,Q.useState)(e),r=o[0],n=o[1],i=(0,Q.useCallback)(function(s){cancelAnimationFrame(t.current),t.current=requestAnimationFrame(function(){n(s)})},[]);return Ft(function(){cancelAnimationFrame(t.current)}),[r,i]},Nt=Oo;var w=a(d());function Te(e,t){t===void 0&&(t=!0);var o=(0,w.useRef)(null),r=(0,w.useRef)(!1),n=(0,w.useRef)(e);n.current=e;var i=(0,w.useCallback)(function(l){r.current&&(n.current(l),o.current=requestAnimationFrame(i))},[]),s=(0,w.useMemo)(function(){return[function(){r.current&&(r.current=!1,o.current&&cancelAnimationFrame(o.current))},function(){r.current||(r.current=!0,o.current=requestAnimationFrame(i))},function(){return r.current}]},[]);return(0,w.useEffect)(function(){return t&&s[1](),s[0]},[]),s}var Ut=a(d());var Lo=function(e,t){e===void 0&&(e=1/0),t===void 0&&(t=1/0);var o=Nt({width:Ce?window.innerWidth:e,height:Ce?window.innerHeight:t}),r=o[0],n=o[1];return(0,Ut.useEffect)(function(){if(Ce){var i=function(){n({width:window.innerWidth,height:window.innerHeight})};return Bt(window,"resize",i),function(){It(window,"resize",i)}}},[]),r},ze=Lo;function He(e,t,o){return e>o?o:e<t?t:e}var Ne=a(d());var j="app/drag";function M(e){return 100*e}function ee(e,t,o,r,n,i=Math.round){let s=M(o),l=i((r-e)/s),x=i((n-t)/s);return[l,x]}function Fe(e){return JSON.parse(e)}function U(e,t,o){let r=m(),n=(0,Ne.useCallback)(s=>{s.preventDefault(),s.dataTransfer.dropEffect="move"},[]),i=(0,Ne.useCallback)(s=>{s.preventDefault();let{id:l,type:x,ox:g,oy:S}=Fe(s.dataTransfer.getData(j)),[y,p]=ee(e+g,t+S,o,s.clientX,s.clientY),c=x==="backdrop"?St({id:l,changes:{x:y,y:p}}):kt({id:l,changes:{x:y,y:p}});r(c)},[r,e,t,o]);return{onDragOver:n,onDrop:i}}var _t=a(u()),Bo=500,Io=.2,zo=3;function Ue({onPaint:e}){let t=m(),[o,r]=(0,v.useState)(0),[n,i]=(0,v.useState)(0),[s,l]=(0,v.useState)(1),[x,g]=Te(()=>{var _;let b=(_=S.current)==null?void 0:_.getContext("2d");b&&S.current&&(e(b,S.current,o,n,s),x())},!0),S=(0,v.useRef)(null),{width:y,height:p}=ze();(0,v.useEffect)(()=>g(),[y,p,o,n,s,g]);let c=(0,v.useCallback)((b,_)=>{r(ae=>ae+b),i(ae=>ae+_)},[]),L=(0,v.useCallback)(b=>{if(b.deltaMode===WheelEvent.DOM_DELTA_PIXEL){let _=b.deltaY/-Bo;l(ae=>He(ae+_,Io,zo))}},[]),P=(0,v.useCallback)(b=>{t(ct({type:"new",x:b.clientX,y:b.clientY})),b.preventDefault()},[t]),{onDragOver:B,onDrop:ne}=U(o,n,s),st=Ie(c),{cursor:me}=st,fo=ye(st,["cursor"]),co=(0,v.useMemo)(()=>({cursor:me,width:y,height:p}),[me,p,y]);return(0,_t.jsx)("canvas",V(W({},fo),{"data-testid":"scrollable-canvas",ref:S,width:y,height:p,style:co,onWheel:L,onDragOver:B,onDrop:ne,onContextMenu:P}))}var k=a(d());function ue(e){return JSON.stringify(e)}var _e=a(u());function We({backdrop:e}){let t=m(),o=f(J),r=f(q),n=(0,k.useMemo)(()=>M(o.z),[o.z]),i=(0,k.useMemo)(()=>e.x*n+o.x,[n,o.x,e.x]),s=(0,k.useMemo)(()=>e.y*n+o.y,[n,o.y,e.y]),l=(0,k.useMemo)(()=>n*e.width,[n,e.width]),x=(0,k.useMemo)(()=>n*e.height,[n,e.height]),g=(0,k.useCallback)(B=>{let ne=B.clientX-i,me=B.clientY-s;B.dataTransfer.setData(j,ue({id:e.id,type:"backdrop",ox:ne,oy:me})),B.dataTransfer.effectAllowed="move",t(X(e.id))},[e.id,t,i,s]),S=(0,k.useCallback)(()=>{t(X())},[t]),{onDragOver:y,onDrop:p}=U(o.x,o.y,o.z),c=f(he),L=(0,k.useMemo)(()=>r!=="backdrop"?"none":!c||c===e.id?"all":"none",[c,r,e.id]),P=(0,k.useMemo)(()=>({position:"absolute",cursor:"pointer",pointerEvents:L,left:i,top:s,zIndex:10,width:l,height:x}),[x,i,L,s,l]);return(0,_e.jsx)("div",{draggable:"true",style:P,onDragStart:g,onDragEnd:S,onDragOver:y,onDrop:p,children:(0,_e.jsx)("img",{src:e.url,alt:e.id,width:l,height:x})})}var pe=a(u());function Ve(){let e=f(Pt);return(0,pe.jsx)(pe.Fragment,{children:e.map(t=>(0,pe.jsx)(We,{backdrop:t},t.id))})}var C=a(d());var te=a(d()),z=a(u()),Wt={display:"flex",width:300,gap:4},Vt={fontWeight:"bold",width:40,textAlign:"right"},Yt={flexGrow:1};function oe({label:e,readOnly:t,value:o,setValue:r}){let n=(0,te.useId)(),i=(0,te.useCallback)(s=>r(s.currentTarget.value),[r]);return(0,z.jsxs)("div",{style:Wt,children:[(0,z.jsx)("label",{htmlFor:n,style:Vt,children:e}),(0,z.jsx)("input",{id:n,style:Yt,type:"string",value:o,readOnly:t,onChange:i})]})}function R({label:e,value:t,setValue:o,min:r,max:n}){let i=(0,te.useId)(),s=(0,te.useCallback)(l=>o(l.currentTarget.valueAsNumber),[o]);return(0,z.jsxs)("div",{style:Wt,children:[(0,z.jsx)("label",{htmlFor:i,style:Vt,children:e}),(0,z.jsx)("input",{id:i,style:Yt,type:"number",value:t,onChange:s,min:r,max:n})]})}var Zt=a(d());function h(e,t){return(0,Zt.useCallback)(o=>e(r=>V(W({},r),{[t]:o})),[t,e])}var O=a(u());function Ye({backdrop:e,setBackdrop:t,isNew:o=!1}){let r=h(t,"id"),n=h(t,"url"),i=h(t,"x"),s=h(t,"y"),l=h(t,"width"),x=h(t,"height");return(0,O.jsxs)("fieldset",{children:[(0,O.jsx)(oe,{label:"ID",value:e.id,setValue:r,readOnly:!o}),(0,O.jsx)(oe,{label:"URL",value:e.url,setValue:n}),(0,O.jsx)(R,{label:"X",value:e.x,setValue:i}),(0,O.jsx)(R,{label:"Y",value:e.y,setValue:s}),(0,O.jsx)(R,{label:"Width",value:e.width,setValue:l,min:1}),(0,O.jsx)(R,{label:"Height",value:e.height,setValue:x,min:1})]})}var Fo={position:"fixed",zIndex:100,top:"50%",left:"50%",transform:"translateX(-50%) translateY(-50%)",background:"white",border:"1px solid black",padding:4,display:"flex",flexDirection:"column",overflow:"hidden"},Pe=Fo;var Gt=a(Xe()),H=a(u()),No={display:"flex"},Uo={flexGrow:1};function Ge(){let e=(0,C.useId)(),t=m(),o=f($),[r,n]=(0,C.useState)({id:"",url:"",x:0,y:0,width:1,height:1});(0,C.useEffect)(()=>{(o==null?void 0:o.type)==="newBackdrop"&&n({id:(0,Gt.v4)(),url:"",x:o.x,y:o.y,width:1,height:1})},[o]);let i=(0,C.useCallback)(()=>{t(gt(r)),t(Z())},[r,t]),s=(0,C.useMemo)(()=>{if(!r.id||!r.url)return!0},[r.id,r.url]),l=(0,C.useMemo)(()=>{if((o==null?void 0:o.type)==="newBackdrop"&&r.url)return(0,H.jsx)("img",{src:r.url,alt:r.id,width:64,height:64})},[r.id,r.url,o==null?void 0:o.type]);return(o==null?void 0:o.type)==="newBackdrop"?(0,H.jsxs)("div",{role:"dialog","aria-labelledby":e,style:Pe,children:[(0,H.jsxs)("div",{style:No,children:[(0,H.jsx)("h2",{id:e,style:Uo,children:"New Backdrop..."}),l]}),(0,H.jsx)(Ye,{isNew:!0,backdrop:r,setBackdrop:n}),(0,H.jsx)("button",{disabled:s,onClick:i,children:"OK"})]}):null}var fe=a(d());var de=a(u());function Ke(){let e=m(),t=f(ve),o=f(J),r=(0,fe.useCallback)(()=>{if(e(se()),t){let[s,l]=ee(o.x,o.y,o.z,t.x,t.y,Math.floor);e(Me({type:"newBackdrop",x:s,y:l}))}},[e,t,o]),n=(0,fe.useCallback)(()=>{if(e(se()),t){let[s,l]=ee(o.x,o.y,o.z,t.x,t.y,Math.floor);e(Me({type:"newToken",x:s,y:l}))}},[e,t,o]),i=(0,fe.useMemo)(()=>({position:"absolute",zIndex:100,left:t&&`${t.x}px`,top:t&&`${t.y}px`,background:"white",border:"1px solid black",padding:4,display:(t==null?void 0:t.type)==="new"?"flex":"none",flexDirection:"column"}),[t]);return(0,de.jsxs)("div",{style:i,children:[(0,de.jsx)("button",{onClick:r,children:"New Backdrop..."}),(0,de.jsx)("button",{onClick:n,children:"New Token..."})]})}var T=a(d());var F=a(u());function qe({token:e,setToken:t,isNew:o=!1}){let r=h(t,"id"),n=h(t,"url"),i=h(t,"x"),s=h(t,"y"),l=h(t,"size");return(0,F.jsxs)("fieldset",{children:[(0,F.jsx)(oe,{label:"ID",value:e.id,setValue:r,readOnly:!o}),(0,F.jsx)(oe,{label:"URL",value:e.url,setValue:n}),(0,F.jsx)(R,{label:"X",value:e.x,setValue:i}),(0,F.jsx)(R,{label:"Y",value:e.y,setValue:s}),(0,F.jsx)(R,{label:"Size",value:e.size,setValue:l,min:1,max:5})]})}var Kt=a(Xe()),N=a(u()),_o={display:"flex"},Wo={flexGrow:1};function $e(){let e=(0,T.useId)(),t=m(),o=f($),[r,n]=(0,T.useState)({id:"",url:"",x:0,y:0,size:1});(0,T.useEffect)(()=>{(o==null?void 0:o.type)==="newToken"&&n({id:(0,Kt.v4)(),url:"",x:o.x,y:o.y,size:1})},[o]);let i=(0,T.useCallback)(()=>{t(Dt(r)),t(Z())},[t,r]),s=(0,T.useMemo)(()=>{if(!r.id||!r.url)return!0},[r.id,r.url]),l=(0,T.useMemo)(()=>{if((o==null?void 0:o.type)==="newToken"&&r.url)return(0,N.jsx)("img",{src:r.url,alt:r.id,width:64,height:64})},[o==null?void 0:o.type,r.id,r.url]);return(o==null?void 0:o.type)==="newToken"?(0,N.jsxs)("div",{role:"dialog","aria-labelledby":e,style:Pe,children:[(0,N.jsxs)("div",{style:_o,children:[(0,N.jsx)("h2",{id:e,style:Wo,children:"New Token..."}),l]}),(0,N.jsx)(qe,{isNew:!0,token:r,setToken:n}),(0,N.jsx)("button",{disabled:s,onClick:i,children:"OK"})]}):null}var A=a(d());var Je=a(u());function Qe({token:e}){let t=m(),o=f(J),r=f(q),n=(0,A.useMemo)(()=>M(o.z),[o.z]),i=(0,A.useMemo)(()=>e.x*n+o.x,[n,o.x,e.x]),s=(0,A.useMemo)(()=>e.y*n+o.y,[n,o.y,e.y]),l=(0,A.useMemo)(()=>n*e.size,[n,e.size]),x=(0,A.useCallback)(P=>{let B=P.clientX-i,ne=P.clientY-s;P.dataTransfer.setData(j,ue({id:e.id,type:"token",ox:B,oy:ne})),P.dataTransfer.effectAllowed="move",t(X(e.id))},[t,i,e.id,s]),g=(0,A.useCallback)(()=>{t(X())},[t]),{onDragOver:S,onDrop:y}=U(o.x,o.y,o.z),p=f(he),c=(0,A.useMemo)(()=>r!=="token"?"none":!p||p===e.id?"all":"none",[p,r,e.id]),L=(0,A.useMemo)(()=>({position:"absolute",cursor:"pointer",pointerEvents:c,left:i,top:s,zIndex:20-e.size,width:l,height:l}),[i,c,l,e.size,s]);return(0,Je.jsx)("div",{draggable:"true",style:L,onDragStart:x,onDragEnd:g,onDragOver:S,onDrop:y,children:(0,Je.jsx)("img",{src:e.url,alt:e.id,width:l,height:l})})}var ce=a(u());function je(){let e=f(Tt);return(0,ce.jsx)(ce.Fragment,{children:e.map(t=>(0,ce.jsx)(Qe,{token:t},t.id))})}var et=a(d());var qt=a(d());var $t=a(u());function we(r){var n=r,{children:e,selected:t=!1}=n,o=ye(n,["children","selected"]);let i=(0,qt.useMemo)(()=>({backgroundColor:t?"yellow":void 0}),[t]);return(0,$t.jsx)("button",V(W({role:"menuitemradio","aria-checked":t,style:i},o),{children:e}))}var re=a(u()),Zo={position:"absolute",left:16,bottom:16,zIndex:90};function tt(){let e=m(),t=f(q),o=(0,et.useCallback)(()=>e(Re("backdrop")),[e]),r=(0,et.useCallback)(()=>e(Re("token")),[e]);return(0,re.jsx)("div",{role:"menubar",style:Zo,children:(0,re.jsxs)("div",{role:"group","aria-label":"Active Layer",children:[(0,re.jsx)(we,{onClick:o,selected:t==="backdrop",children:"Backdrop"}),(0,re.jsx)(we,{onClick:r,selected:t==="token",children:"Token"})]})})}var D=a(u());function Jt(e,t){let o=e%t;return o<0?o+t:o}var Xo={overflow:"hidden",position:"relative"};function ot(){let e=m();le(()=>{e(bt([{id:"Birnotec",url:"https://lagdotcom.github.io/dndavies-assets/tk/birnotec.png",x:2,y:3,size:1},{id:"Vassetri",url:"https://5e.tools/img/MM/Yuan-ti%20Abomination.png",x:4,y:4,size:2},{id:"Vassetri2",url:"https://5e.tools/img/MPMM/Yuan-ti%20Anathema.png",x:6,y:3,size:3}]))});let t=(0,Qt.useCallback)((o,r,n,i,s)=>{let{width:l,height:x}=r;o.clearRect(0,0,l,x);let g=M(s),S=Jt(n,g),y=Jt(i,g);o.lineWidth=1,o.strokeStyle="silver";for(let p=S;p<l;p+=g)o.beginPath(),o.moveTo(p,0),o.lineTo(p,x),o.stroke();for(let p=y;p<x;p+=g)o.beginPath(),o.moveTo(0,p),o.lineTo(l,p),o.stroke();e(mt({x:n,y:i,z:s}))},[e]);return(0,D.jsxs)("div",{style:Xo,children:[(0,D.jsx)(Ue,{onPaint:t}),(0,D.jsx)(Ve,{}),(0,D.jsx)(je,{}),(0,D.jsx)(Ot,{}),(0,D.jsx)(Lt,{}),(0,D.jsx)(Ke,{}),(0,D.jsx)(Ge,{}),(0,D.jsx)($e,{}),(0,D.jsx)(tt,{})]})}var ro=a(Oe());var to=a(Y());var jt=a(Y());var Go=(0,jt.combineReducers)({app:xt,backdrops:vt,tokens:Ct}),eo=Go;function oo(e){return(0,to.configureStore)({reducer:eo,preloadedState:e})}var rt=a(u()),Ko=oo();function nt(){return(0,rt.jsx)(ro.Provider,{store:Ko,children:(0,rt.jsx)(ot,{})})}var lo=a(io()),po=a(u()),uo=document.getElementById("app");if(!uo)throw new Error("app container missing");var qo=(0,lo.createRoot)(uo);qo.render((0,po.jsx)(nt,{}));})();
